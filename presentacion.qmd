---
title: "Más Allá de la Predicción: Optimizando Estrategias de Contacto"
subtitle: "Un Análisis Causal para el Segmento de 'Primer Contacto' del BPS"
author: "Equipo de Ciencia de Datos"
date: today
format:
  revealjs:
    theme: simple
    slide-number: true
    chalkboard: true
---

```{r setup, include=FALSE}
# Carga de librerías necesarias
library(tidyverse)
library(bpsCapacitacionSimulacionSimpson)
```

```{r simulacion, include=FALSE, echo=FALSE, warning=FALSE, cache=TRUE}
# Este chunk ejecuta toda la simulación de alta calidad.
# Usamos cache=TRUE para no re-ejecutarlo en cada renderizado.

# 1. Fijamos una semilla para reproducibilidad total
set.seed(42)

# 2. Ejecutamos la simulación Monte Carlo
resultados_mc <- ejecutar_simulacion_mc(
  N_simulaciones = 2000,
  n_empresas_total = 100000
)

# 3. Resumimos los resultados
resumen_simulacion <- resumir_simulacion(resultados_mc)
```

## Nuestro Foco: El Primer Contacto

- Nos enfocamos en un segmento clave: empresas con deudas significativas (>12 meses) que aún no hemos contactado.

- La pregunta clave: Para este grupo, ¿cuál es la acción inicial más efectiva? ¿Un contacto ligero? ¿Uno más involucrado? ¿O es mejor no hacer nada?

::: {.notes}
"Hola a todos. Hoy vamos a presentar los resultados de una simulación diseñada para responder a una pregunta muy específica y operativa: ¿cómo debemos iniciar el contacto con las empresas que tienen deudas importantes pero con las que nunca hemos hablado?"

"Las opciones tienen costos muy diferentes. Un contacto ligero es barato, uno involucrado es caro, y no hacer nada tiene un costo de oportunidad. Necesitamos saber qué funciona mejor y para quién."
:::

## Nuestro Experimento: Un Universo Simulado y Realista

- Creamos un "laboratorio digital" que imita este segmento.

- Crucialmente, a cada empresa le asignamos una "cultura de pago" oculta (Baja, Media, Alta), algo que en la realidad solo podemos intuir.

::: {.notes}
"Para explorar estas opciones de forma segura, hemos construido una simulación. Este universo digital refleja las características de este segmento de 'primer contacto'."

"La variable secreta que introducimos, la 'cultura de pago', es la que nos permitirá descubrir si nuestras estrategias están bien dirigidas o si están siendo confundidas por factores que no vemos."
:::

## La Visión Agregada: No Contactar Parece lo Mejor

```{r grafico-agregado, echo=FALSE, fig.align='center', out.width="80%"}
# Filtramos los datos para mostrar SOLO el resultado agregado
resumen_agregado <- resumen_simulacion |>
  dplyr::filter(grupo_cultura == "Agregado")

# Generamos un gráfico específico para esta diapositiva
graficar_paradoja_simpson(
  resumen_agregado,
  titulo = "A Nivel General, la Inacción Parece la Estrategia Ganadora",
  subtitulo = "Tasa de regularización promedio según el tipo de primer contacto"
)
```

::: {.notes}
"Si analizamos los resultados de todas las empresas juntas, el gráfico muestra algo sorprendente."

"La barra más alta, la que indica la mayor tasa de regularización, corresponde a 'Ausencia de Contacto'. La conclusión inmediata sería que nuestra mejor estrategia es no gastar recursos y simplemente esperar."

"Esto parece contraintuitivo. Y, como vamos a ver, es una conclusión completamente errónea, producto de una ilusión estadística."
:::

## La Revelación: La Estrategia Óptima está Segmentada

```{r grafico-completo, echo=FALSE, fig.align='center', out.width="100%"}
# Ahora mostramos el gráfico completo, sin filtrar, con todas las facetas
graficar_paradoja_simpson(resumen_simulacion)
```

::: {.notes}
"Ahora, veamos la imagen completa. Este es el mismo análisis, pero ahora separado por la 'cultura de pago' que conocíamos en nuestra simulación."

"(Señalar faceta 'Cultura Baja') Para las empresas que son 'malas pagadoras', la 'Ausencia de Contacto' es la peor estrategia. Aquí, el 'Contacto Involucrado' es, por lejos, el más efectivo."

"(Señalar faceta 'Cultura Alta') Para las que son 'buenas pagadoras', ocurre lo contrario. Ya tenían una alta probabilidad de pagar, por lo que cualquier contacto es un gasto de recursos innecesario. 'Ausencia de Contacto' es la estrategia más eficiente."

"La conclusión general era una ilusión. La verdadera optimización está en aplicar la estrategia correcta al segmento correcto."
:::

## La Causa: El Sesgo de Selección

- Nuestro modelo predictivo es bueno identificando a las empresas de "Alta Cultura de Pago".

- Nuestra estrategia de asignación (lógica) fue: "No molestemos a los que seguramente pagarán solos".

- **Consecuencia:** Llenamos el grupo de "Ausencia de Contacto" con las mejores empresas, inflando artificialmente su tasa de éxito y haciendo que pareciera la mejor estrategia general.

::: {.notes}
"La explicación es la misma que antes, pero en este nuevo contexto: el modelo predictivo funciona, pero la estrategia de decisión basada en él crea grupos que no son comparables."

"Estamos comparando peras con manzanas. El grupo 'Sin Contacto' está lleno de empresas excelentes, mientras que los grupos de contacto activo están llenos de los casos más difíciles. Por eso el promedio general es engañoso."
:::

## Conclusiones y Recomendación Accionable

### Conclusiones

1.  Una estrategia de contacto de “talla única” es ineficiente y subóptima.
2.  La optimización real de recursos proviene de aplicar la intervención correcta al segmento causal correcto.

### Recomendación

Proponemos un **piloto de A/B testing** en el segmento de "primer contacto" para medir el impacto causal real de las estrategias "Ligera" vs. "Involucrada" y validar estos hallazgos.

::: {.notes}
"La lección principal de esta simulación es que debemos pasar de una estrategia basada solo en predicción a una basada en causalidad y segmentación."

"Como próximo paso concreto, proponemos tomar estos aprendizajes y llevarlos al mundo real. Diseñemos un experimento controlado donde a un grupo aleatorio de empresas difíciles se les asigne un contacto ligero y a otro un contacto involucrado. Solo así podremos medir el verdadero retorno de la inversión de nuestras acciones y tomar decisiones basadas en evidencia causal."

"Gracias."
:::


## Anexo {.inverse}


## Anatomía de la Simulación
### El Proceso de Generación de Datos (DGP)

::: {.notes}
"Para aquellos interesados en los detalles técnicos, las siguientes diapositivas explican exactamente cómo construimos nuestro universo simulado. Nuestro objetivo aquí es la total transparencia."
:::


## La Receta: Pasos Clave del DGP

1.  **Crear Universo Inicial:** Generamos una población grande y realista de empresas.
2.  **Filtrar Segmento Clave:** Nos enfocamos en el segmento estratégico: deudas antiguas, sin contacto previo.
3.  **Asignar 'Cultura de Pago':** A cada empresa del segmento le asignamos aleatoriamente una "cultura de pago" oculta (Baja, Media o Alta). Este es nuestro *confounder*.
4.  **Generar Datos Observables:** Creamos variables realistas (como `riesgo_deuda`) cuya distribución depende de la cultura de pago.
5.  **Simular Decisión del BPS:** Asignamos el tipo de contacto (`Ausencia`, `Ligero`, `Involucrado`) de forma sesgada, usando un modelo predictivo "casi perfecto".

::: {.notes}
"El proceso sigue una secuencia lógica. Primero definimos el quiénes (el segmento), luego introducimos la variable oculta que causa la confusión, y finalmente simulamos la toma de decisiones del BPS que introduce el sesgo de selección que queremos estudiar."
:::

## El Motor Causal: De Variables a Resultados

A continuación, se desglosa el código que define la "verdad" de nuestro universo para el resultado potencial `Y_ausencia` (la regularización si no hay contacto).

```{r logit-code-detailed-1, echo=TRUE, eval=FALSE}
logit_baseline = -2.5 + (as.integer(cultura_pago_real) * 2.5) - (riesgo_deuda * 0.5)
Y_ausencia = rbinom(n(), 1, plogis(logit_baseline))
```

#### Desglose de la Lógica:

**1. `logit_baseline` (La "Puntuación de Voluntad de Pago"):**  
-   ` -2.5`: **El Intercepto.** Es el punto de partida; un valor negativo que representa la dificultad inherente de que alguien pague sin una buena razón.  
-   `(as.integer(cultura_pago_real) * 2.5)`: **El Factor Causal Oculto.** El motor principal. La `cultura_pago_real` (convertida a 1, 2, 3) tiene el mayor impacto positivo. Es el *confounder*.  
-   `- (riesgo_deuda * 0.5)`: **El Factor Observable.** A mayor `riesgo_deuda`, menor es la puntuación, añadiendo realismo.  

::: {.notes}
"Vamos a desglosar estas dos líneas de código, que son el cerebro de toda la simulación."

"Primero, calculamos una 'puntuación de voluntad de pago'. Empezamos con un entorno difícil (el -2.5), luego le damos un gran impulso a las empresas con buena cultura de pago (el factor más importante) y penalizamos un poco a las que tienen más riesgo."

"Esta puntuación no es una probabilidad, así que usamos `plogis` como un conversor estándar para transformarla en una probabilidad entre 0% y 100%."

:::

## El Motor Causal: De Variables a Resultados

A continuación, se desglosa el código que define la "verdad" de nuestro universo para el resultado potencial `Y_ausencia` (la regularización si no hay contacto).

```{r logit-code-detailed-2, echo=TRUE, eval=FALSE}
logit_baseline = -2.5 + (as.integer(cultura_pago_real) * 2.5) - (riesgo_deuda * 0.5)
Y_ausencia = rbinom(n(), 1, plogis(logit_baseline))
```

#### Desglose de la Lógica:

**2. `plogis(...)` (De Puntuación a Probabilidad):**
-   La "puntuación" logit puede ser cualquier número. `plogis` (la función logística inversa) la transforma matemáticamente en una **probabilidad válida**, siempre entre 0 y 1.

::: {.notes}
"Esta puntuación no es una probabilidad, así que usamos `plogis` como un conversor estándar para transformarla en una probabilidad entre 0% y 100%."

:::

## El Motor Causal: De Variables a Resultados

A continuación, se desglosa el código que define la "verdad" de nuestro universo para el resultado potencial `Y_ausencia` (la regularización si no hay contacto).

```{r logit-code-detailed-3, echo=TRUE, eval=FALSE}
logit_baseline = -2.5 + (as.integer(cultura_pago_real) * 2.5) - (riesgo_deuda * 0.5)
Y_ausencia = rbinom(n(), 1, plogis(logit_baseline))
```

#### Desglose de la Lógica:

**3. `Y_ausencia` (El Resultado Potencial):**
-   Esta variable representa el escenario hipotético: ¿qué empresas regularizarían (`1`) y cuáles no (`0`) si **todas** fueran asignadas al grupo de "Ausencia de Contacto"?

::: {.notes}
"`Y_ausencia` es nuestra primera 'verdad'. Es una columna que dice, para cada empresa, si pagaría o no si no hiciéramos nada."
:::

## El Motor Causal: De Variables a Resultados

A continuación, se desglosa el código que define la "verdad" de nuestro universo para el resultado potencial `Y_ausencia` (la regularización si no hay contacto).

```{r logit-code-detailed-4, echo=TRUE, eval=FALSE}
logit_baseline = -2.5 + (as.integer(cultura_pago_real) * 2.5) - (riesgo_deuda * 0.5)
Y_ausencia = rbinom(n(), 1, plogis(logit_baseline))
```

#### Desglose de la Lógica:

**4. `rbinom(...)` (El "Tiro de Moneda"):**
-   Una empresa con 80% de probabilidad no puede "80% pagar". `rbinom` simula el evento aleatorio. Para cada empresa, "lanza una moneda" (`size = 1`) que está sesgada con la probabilidad que calculamos. Esto introduce el azar del mundo real y genera el resultado final (`0` o `1`).

::: {.notes}
"Finalmente, `rbinom` es el factor suerte. Si una empresa tiene un 80% de probabilidad de pagar, `rbinom` simula un evento que resultará en 'paga' (1) el 80% de las veces y 'no paga' (0) el 20% restante. Así pasamos de una probabilidad a un hecho concreto."
:::

## La Decisión Sesgada: Asignación de Tratamiento

Simulamos una estrategia racional: no gastar recursos en quienes tienen alta probabilidad de pagar, y usar los contactos más intensivos en los casos más difíciles.

El código que implementa esta regla de negocio es:

```{r case-when-code, echo=TRUE, eval=FALSE}
# ... dentro de un mutate() ...
tipo_contacto_BPS = case_when(
  prob_predictiva_modelo > 0.8 ~ "Ausencia de Contacto",
  prob_predictiva_modelo > 0.5 ~ "Contacto Ligero",
  TRUE                        ~ "Contacto Involucrado"
)
```

::: {.notes}
"Este fragmento de código es el que introduce deliberadamente el sesgo de selección. Asignamos el tratamiento 'fácil' (Ausencia de Contacto) a las empresas con la predicción más alta, que, como vimos, están correlacionadas con la 'Cultura de Pago Alta'."

"Es esta asignación, aunque parezca lógica desde el punto de vista de recursos, la que genera la Paradoja de Simpson en los resultados agregados."
:::